
# Current Issues Diagnostic Report
**Generated:** January 2025  
**System:** Treasure Home School Portal

---

## üö® CRITICAL ISSUE: Teacher Profile Database Table Missing

### Problem
The `teacher_profiles` table does not exist in your database, causing profile submission to fail.

### Evidence
```
PostgresError: relation "teacher_profiles" does not exist
```

### Root Cause
- Migration file `0012_add_teacher_profiles.sql` exists in codebase
- BUT the migration was **NEVER executed** on your Supabase database
- Application code expects the table (schema defines it)
- When teachers try to submit profile ‚Üí backend queries non-existent table ‚Üí error

### Impact
- ‚ùå Teachers cannot complete profile setup
- ‚ùå Profile submission fails with "Failed to fetch" error
- ‚ùå Dashboard access blocked for teachers
- ‚ùå `/api/teacher/profile/status` endpoint returns 500 error

### Files Affected
1. `server/routes.ts` - Line 1007 (profile status check)
2. `server/routes.ts` - Lines 835-900 (profile creation endpoint)
3. `server/storage.ts` - Line 957 (`getTeacherProfile()` method)
4. `client/src/pages/portal/TeacherDashboard.tsx` - Lines 21-28 (profile check)
5. `migrations/0012_add_teacher_profiles.sql` - Migration file not executed

---

## üìã SECONDARY ISSUES

### Issue 1: Vite Connection Instability
**Status:** Active  
**Evidence from console:**
```
[vite] server connection lost. Polling for restart...
```

**Likely Cause:**
- Heavy auto-publish and cleanup background services
- Database connection pool saturation
- Frequent server restarts during development

**Impact:**
- Frontend loses connection to dev server
- Hot reload may fail
- Development experience degraded

---

### Issue 2: Migration System Out of Sync
**Status:** Critical  
**Evidence:**
```
Migrations already applied: Failed query: CREATE TYPE "public"."attendance_status"...
```

**Problem:**
- Migration system shows "already applied" but skipped migration 0012
- Database schema incomplete vs. application schema
- Drizzle migration tracking may be corrupted

**Impact:**
- Future migrations may fail
- Schema drift between code and database
- Data integrity at risk

---

## üîß IMMEDIATE FIXES NEEDED

### Fix 1: Run the Missing Migration
**Priority:** CRITICAL  
**Action Required:**

```sql
-- Execute this directly on Supabase SQL Editor
-- Or run: psql $DATABASE_URL -f migrations/0012_add_teacher_profiles.sql

CREATE TABLE IF NOT EXISTS teacher_profiles (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL UNIQUE REFERENCES users(id),
  staff_id VARCHAR(50) UNIQUE,
  subjects INTEGER[] DEFAULT '{}',
  assigned_classes INTEGER[] DEFAULT '{}',
  qualification VARCHAR(100),
  years_of_experience INTEGER DEFAULT 0,
  specialization VARCHAR(200),
  department VARCHAR(100),
  signature_url TEXT,
  grading_mode VARCHAR(50) DEFAULT 'manual',
  notification_preference VARCHAR(50) DEFAULT 'all',
  availability VARCHAR(50),
  first_login BOOLEAN DEFAULT true,
  verified BOOLEAN DEFAULT false,
  verified_by UUID REFERENCES users(id),
  verified_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_teacher_profiles_user_id ON teacher_profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_teacher_profiles_staff_id ON teacher_profiles(staff_id);
```

### Fix 2: Verify Database Connection
**Priority:** HIGH  
**Check:**
- Supabase connection pool settings
- Connection timeout configurations
- Active connection count

---

## üîç VERIFICATION STEPS

After applying fixes:

1. **Verify Table Creation:**
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_name = 'teacher_profiles';
```

2. **Test Profile Status Endpoint:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-repl.replit.dev/api/teacher/profile/status
```

3. **Test Profile Submission:**
- Login as teacher
- Navigate to `/portal/teacher/profile-setup`
- Fill and submit form
- Check for successful creation

---

## üìä SYSTEM HEALTH CHECK

### Database Connection Pool
- Max connections: 20
- Idle timeout: 300s
- Connection timeout: 30s
- ‚úÖ Configuration looks good

### Background Services
- ‚úÖ Auto-publish: Running (1 min interval)
- ‚úÖ Timeout cleanup: Running (3 min interval)
- ‚ö†Ô∏è May need throttling if causing connection issues

### Migration Tracking
- ‚ùå Out of sync - migration 0012 skipped
- ‚ö†Ô∏è Drizzle meta tables may need reset

---

## üöÄ RECOMMENDED ACTION PLAN

### Step 1: Execute Missing Migration (URGENT)
Run the SQL script above on Supabase

### Step 2: Restart Application
Clear any cached migration state

### Step 3: Test Teacher Workflow
1. Login as teacher
2. Complete profile setup
3. Verify dashboard access

### Step 4: Monitor Logs
Watch for any recurring errors

### Step 5: Database Health Check
Verify all expected tables exist:
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

---

## üìù PREVENTION MEASURES

1. **Migration Verification:**
   - Always verify migrations run successfully
   - Check Supabase logs after deployment
   - Add migration verification to deployment checklist

2. **Connection Monitoring:**
   - Set up alerts for connection pool saturation
   - Monitor Vite dev server stability
   - Log all database errors clearly

3. **Schema Sync:**
   - Regularly compare code schema vs. DB schema
   - Use `drizzle-kit push` with caution
   - Document any manual schema changes

---

## üÜò IF FIXES DON'T WORK

1. **Nuclear Option - Recreate Teacher Profiles Table:**
   ```sql
   DROP TABLE IF EXISTS teacher_profiles CASCADE;
   -- Then run creation script above
   ```

2. **Reset Migration Tracking:**
   ```sql
   -- Check migration meta table
   SELECT * FROM drizzle.__drizzle_migrations;
   ```

3. **Contact Support:**
   - Supabase support for database issues
   - Replit support for deployment issues

---

**Last Updated:** Based on console logs from latest session  
**Status:** AWAITING FIX EXECUTION
