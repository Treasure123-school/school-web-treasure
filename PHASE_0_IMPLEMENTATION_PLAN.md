# PHASE 0: Discovery & Pre-Change Plan
## Teacher-Student-Department-Class Assignment & Report Card Automation System

**Generated:** November 30, 2025  
**Status:** AWAITING APPROVAL before Phase 1

---

## 1. CURRENT SYSTEM INVENTORY

### 1.1 Database Tables (PostgreSQL via Neon)

| Table | Purpose | Key Fields |
|-------|---------|------------|
| `users` | All user accounts | id (varchar/UUID), username (THS-XXX-###), roleId, email |
| `roles` | Role definitions | id (serial), name (Super Admin, Admin, Teacher, Student, Parent) |
| `students` | Student profiles | id (FK users), classId, parentId, **department**, admissionNumber |
| `teacher_profiles` | Teacher details | userId, subjects (JSON), assignedClasses (JSON), **department**, verified |
| `classes` | Class definitions | id, name, level, classTeacherId |
| `subjects` | Subject catalog | id, name, code, **category** (general/science/art/commercial) |
| `teacher_class_assignments` | Teacher-Class-Subject links | teacherId, classId, subjectId, **department**, termId |
| `academic_terms` | Term definitions | id, name, year, startDate, endDate, isCurrent |
| `report_cards` | Report card headers | studentId, classId, termId, status, signedBy, autoGenerated |
| `report_card_items` | Subject-level scores | reportCardId, subjectId, teacherId, testScore, examScore, grade |
| `exams` | Exam definitions | id, title, classId, subjectId, examType |
| `exam_sessions` | Student exam attempts | studentId, examId, status, score |
| `exam_results` | Computed results | sessionId, totalScore, percentage |
| `settings` | Key-value settings | key, value (JSON) |
| `system_settings` | Global config | gradingScale, testWeight, examWeight |
| `audit_logs` | Action audit trail | userId, action, entityType, entityId, timestamps |
| `counters` | Username sequence | roleCode, sequence |

### 1.2 Existing API Endpoints (server/routes.ts)

**Authentication:**
- POST `/api/auth/login` - Login with username/email
- POST `/api/auth/change-password` - Change password
- GET `/api/auth/me` - Get current user

**User Management:**
- POST/PUT `/api/users` - Create/update users
- POST `/api/users/:id/verify` - Verify user
- POST `/api/users/:id/role` - Change role

**Classes & Subjects:**
- GET/POST/PUT/DELETE `/api/classes` - Class CRUD
- GET/POST/PUT/DELETE `/api/subjects` - Subject CRUD

**Teacher Assignments:**
- GET/POST `/api/teacher-assignments` - Get/create assignments
- PUT/DELETE `/api/teacher-assignments/:id` - Update/delete
- GET `/api/teachers-for-subject` - Get teachers for subject

**Students:**
- GET/POST `/api/students` - List/create students
- GET/PATCH/DELETE `/api/students/:id` - Student CRUD
- GET `/api/students/:id/classes` - Get student classes

**Report Cards:**
- GET `/api/reports/student-report-card/:studentId` - Get student report
- GET `/api/reports/class-term/:classId/:termId` - Get class reports
- GET `/api/reports/:reportCardId/full` - Get full report
- POST `/api/reports/generate/:classId` - Generate class reports
- POST `/api/reports/:reportCardId/auto-populate` - Auto-populate scores
- PATCH `/api/reports/items/:itemId/override` - Override score
- PATCH `/api/reports/:reportCardId/status` - Change status
- PATCH `/api/reports/:reportCardId/remarks` - Add remarks

**Exams:**
- GET/POST `/api/exams` - List/create exams
- GET/PATCH/DELETE `/api/exams/:id` - Exam CRUD
- PATCH `/api/exams/:id/publish` - Publish exam
- POST `/api/exams/:id/submit` - Submit exam

### 1.3 Frontend Pages (client/src/pages)

**Admin/Management:**
- `ClassesManagement.tsx` - Manage classes
- `SubjectsManagement.tsx` - Manage subjects
- `StudentManagement.tsx` - Manage students
- `TeachersManagement.tsx` - Manage teachers
- `AcademicTermsManagement.tsx` - Manage terms
- `ReportsManagement.tsx` - Reports overview

**Teacher:**
- `TeacherDashboard.tsx` - Teacher home
- `TeacherProfileSetup.tsx` - Profile setup
- `TeacherReportCards.tsx` - Manage report cards
- `TeacherClassResults.tsx` - View class results
- `TeacherGradingQueue.tsx` - Grade submissions

**Student:**
- `StudentDashboard.tsx` - Student home
- `StudentReportCard.tsx` - View report card
- `StudentExams.tsx` - Take exams
- `StudentExamResults.tsx` - View results

**Parent:**
- `ParentDashboard.tsx` - Parent home
- `ParentReportCards.tsx` - View child reports

### 1.4 Realtime Events (server/realtime-service.ts)

- `emitReportCardEvent()` - Report card CRUD events
- `emitBulkReportCardStatusChange()` - Bulk status changes
- `emitTableChange()` - Generic table change events
- `emitToRole()` - Role-based notifications
- `emitToClass()` - Class-based notifications
- `emitToUser()` - User-specific notifications

### 1.5 Auth Flow

1. Username format: `THS-{ROLE}-{###}` (e.g., THS-STU-021, THS-TCH-005)
2. Password: `THS@{YEAR}#{RANDOM}` for system-generated
3. Role IDs: 1=SuperAdmin, 2=Admin, 3=Teacher, 4=Student, 5=Parent
4. JWT-based authentication
5. Session management via express-session

### 1.6 Existing Report Card Logic

1. **Generation:** Manual or batch generation per class/term
2. **Auto-population:** Pulls scores from exam_sessions/exam_results
3. **Scoring:** testScore (40%) + examScore (60%) = total
4. **Grading:** Configurable grading scale in system_settings
5. **Status Flow:** draft -> finalized -> published
6. **Override:** Teachers can override auto-calculated scores
7. **Realtime:** Status changes emit socket events

---

## 2. GAP ANALYSIS: Current vs Required

### 2.1 What EXISTS and Works

| Requirement | Current Status |
|-------------|----------------|
| Username format THS-XXX-### | YES - Already implemented |
| Subjects with category | YES - category field exists |
| Classes with level | YES - level field exists |
| Teacher assignments (class/subject) | YES - teacher_class_assignments table |
| Students with department | YES - department field exists |
| Report cards with scores | YES - reportCards + reportCardItems |
| Test/Exam score separation | YES - testScore, examScore fields |
| Grading weights in settings | YES - system_settings has weights |
| Audit logging | YES - audit_logs table |
| Realtime updates | YES - Socket.IO implemented |

### 2.2 What NEEDS Enhancement

| Requirement | Gap | Solution |
|-------------|-----|----------|
| Username as canonical ID | Username exists but not enforced as primary lookup | Add NOT NULL constraint, backfill missing usernames |
| Department auto-assignment for SS1-SS3 | Logic exists but may need validation | Verify and enhance student creation flow |
| Auto-generate report card on first exam | Currently manual/batch only | Add event trigger on exam submission |
| Teacher editable test AND exam scores | Needs explicit edit functionality | Add dedicated score editing endpoints |
| Signed by teacher_username | Uses user.id currently | Add signed_by_username field or use JOIN |
| Settings table for grading weights | Uses system_settings JSON | Verify or add key-value settings entries |

### 2.3 What NEEDS to be ADDED

| Feature | Implementation Needed |
|---------|----------------------|
| Auto-report card on first exam per term | Trigger in exam submit handler |
| Teacher test score edit (40%) restriction | Update override API validation |
| Position/ranking calculation | Add calculation on finalize |
| Department-based subject filtering | Filter subjects by department for SS1-SS3 |

---

## 3. IMPLEMENTATION PLAN

### Phase 1: Data Model & Migrations

**Tasks:**
1. Verify username NOT NULL constraint (add if missing)
2. Add index on username column (if not exists)
3. Verify subjects.category values align with requirements
4. Verify teacher_class_assignments has department field
5. Add signed_by_username to report_cards (optional, can use JOIN)
6. Verify settings table has grading weight entries

**Migration Safety:**
- Export database backup before any changes
- Use `npm run db:push --force` (Drizzle handles this safely)
- NO manual SQL migrations needed

**Estimated Effort:** 2-3 hours

### Phase 2: Business Logic Updates

**Tasks:**
1. **Auto-report card generation:**
   - Hook into exam submission handler
   - Check if report card exists for student/term
   - If not, create new report_card + initial items

2. **Teacher score editing restrictions:**
   - Modify `/api/reports/items/:itemId/override` endpoint
   - Allow teachers to edit test_score only (40%)
   - Auto-calculate total from test (40%) + exam (60%)

3. **Department auto-assignment:**
   - Enhance student creation logic
   - Auto-set department for SS1/SS2/SS3 based on subject selection

4. **Position calculation:**
   - Add ranking logic on report card finalization
   - Calculate position within class

**Estimated Effort:** 4-6 hours

### Phase 3: API Enhancements

**New/Modified Endpoints:**
- PATCH `/api/reports/items/:itemId/test-score` - Teacher edit test score only
- POST `/api/reports/auto-generate/:studentId/:termId` - Auto-generate on exam

**Existing Endpoint Updates:**
- POST `/api/exams/:id/submit` - Trigger auto-report generation
- PATCH `/api/reports/:id/status` - Calculate positions on finalize

**Estimated Effort:** 3-4 hours

### Phase 4: Frontend Updates

**Pages to Modify:**
- `TeacherReportCards.tsx` - Test score edit only UI
- `StudentManagement.tsx` - Department auto-assignment display
- `ReportsManagement.tsx` - Show auto-generated report cards

**Estimated Effort:** 2-3 hours

### Phase 5: Testing & Validation

**Test Cases:**
1. Student takes first exam -> Report card auto-created
2. Teacher edits test score -> Total recalculates
3. SS1 student -> Department auto-assigned
4. Report finalized -> Positions calculated
5. Audit log entries for all changes

**Estimated Effort:** 2-3 hours

---

## 4. ROLLBACK STEPS

### Database Rollback
```bash
# If using Neon, restore from point-in-time recovery
# Or restore from pre-migration backup
```

### Code Rollback
```bash
# Git-based rollback
git log --oneline  # Find commit before changes
git revert <commit-hash>
```

### Feature Flags (Optional)
- Add `ENABLE_AUTO_REPORT_CARD=true/false` env var
- Allows disabling new features without full rollback

---

## 5. DEPLOYMENT CHECKLIST

### Pre-Deployment
- [ ] Export database backup
- [ ] Review all changes in staging
- [ ] Run all test cases
- [ ] Verify realtime events work

### Deployment Steps
1. [ ] Apply database migrations (`npm run db:push`)
2. [ ] Deploy backend changes
3. [ ] Deploy frontend changes
4. [ ] Verify all endpoints respond correctly
5. [ ] Test realtime updates

### Post-Deployment
- [ ] Monitor error logs for 24 hours
- [ ] Verify audit logs capture changes
- [ ] Test end-to-end with real users
- [ ] Document any issues for hotfix

---

## 6. SUMMARY

### What's Already Working
- Core user/role system with THS-XXX-### usernames
- Subject categories (general/science/art/commercial)
- Teacher-class-subject assignments with department
- Report cards with test/exam score separation
- Audit logging and realtime updates

### What Needs Implementation
1. **Auto-report card on first exam** - New trigger logic
2. **Teacher test-score-only editing** - API restriction
3. **Department auto-assignment** - Enhanced student creation
4. **Position calculation** - New finalization logic

### Estimated Total Effort
- Phase 1 (Migrations): 2-3 hours
- Phase 2 (Business Logic): 4-6 hours
- Phase 3 (APIs): 3-4 hours
- Phase 4 (Frontend): 2-3 hours
- Phase 5 (Testing): 2-3 hours
- **Total: 13-19 hours**

---

## APPROVAL REQUIRED

**Before proceeding to Phase 1, please confirm:**

1. Is this analysis accurate?
2. Are the implementation priorities correct?
3. Any additional requirements not captured?
4. Approved to proceed?

---

*Document generated based on codebase analysis of shared/schema.pg.ts, server/routes.ts, server/storage.ts, and related files.*
